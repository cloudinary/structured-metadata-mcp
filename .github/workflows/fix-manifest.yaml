name: Fix Manifest
on:
  workflow_call:
    inputs:
      branch_name:
        description: The branch name to fix manifest.json on
        required: true
        type: string
      base_branch:
        description: The base branch to restore manifest.json from
        required: false
        type: string
        default: main

permissions:
  contents: write

jobs:
  fix-manifest:
    name: Fix manifest.json
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Fix manifest.json
        run: |
          set -e  # Exit on any error

          echo "Fixing manifest.json to preserve only version changes..."

          # Check if manifest.json exists
          if [ ! -f manifest.json ]; then
            echo "Error: manifest.json not found"
            exit 1
          fi

          # Extract the current version from the generated manifest.json
          NEW_VERSION=$(jq -r '.version' manifest.json)
          if [ -z "$NEW_VERSION" ] || [ "$NEW_VERSION" = "null" ]; then
            echo "Error: Could not extract version from manifest.json"
            exit 1
          fi
          echo "New version: $NEW_VERSION"

          # Determine the base branch
          BASE_BRANCH="${{ inputs.base_branch }}"
          echo "Base branch: $BASE_BRANCH"

          # Restore manifest.json from the base branch
          if ! git show "origin/$BASE_BRANCH:manifest.json" > /tmp/base_manifest.json; then
            echo "Error: Could not restore manifest.json from origin/$BASE_BRANCH"
            exit 1
          fi
          echo "Restored manifest.json from $BASE_BRANCH"

          # Update only the version field in the base manifest
          if ! jq --arg version "$NEW_VERSION" '.version = $version' /tmp/base_manifest.json > manifest.json; then
            echo "Error: Failed to update version in manifest.json"
            exit 1
          fi

          echo "Successfully updated manifest.json with version: $NEW_VERSION"

      - name: Commit and push if changed
        run: |
          set -e  # Exit on any error

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet manifest.json; then
            echo "No changes to manifest.json, nothing to commit"
          else
            echo "Changes detected in manifest.json, committing..."
            git add manifest.json
            git commit -m "fix: revert manifest.json changes except version" -m "Automatically reverted unwanted manifest.json changes while preserving version updates from SDK generation."
            git push origin ${{ inputs.branch_name }}
            echo "Successfully pushed manifest.json fix"
          fi
